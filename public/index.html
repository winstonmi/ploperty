<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Theme Made By www.w3schools.com - No Copyright --><!-- Still, you deserve a good mention :) -->
  <title>Ploperty - Just Mi</title>
    <meta charset="utf-8">
    <META name="viewport" content="width=device-width, initial-scale=1">
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache">
    <META HTTP-EQUIV="Expires" CONTENT="-1">
    <script src="https://code.jquery.com/jquery-3.1.0.min.js"  integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Mapbox.js -->
    <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular-resource.js"></script>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link href="http://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">
    <link href="./style/style.css" rel="stylesheet" type="text/css">

    <style>
      body { margin:0; padding:0; }
      .map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>

<body ng-app="Ploperty" ng-controller="PlopertyController as Ploperty" id="myPage" data-spy="scroll" data-target=".navbar" data-offset="50">

<!-- Leaflet (Marker Cluster Section) -->
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js'></script>
  <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.css' rel='stylesheet' />
  <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.Default.css' rel='stylesheet' />

<div id="myPage" class="">
</div>
<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#myPage">PLOPERTY</a>
    </div>
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="#myPage">HOME</a></li>
        <li><a href="#data">DATA</a></li>
      </ul>
    </div>
  </div>
</nav>

<div id='map-cluster' class='map'></div>

<div id='search'>
  <form class="navbar-form">
      <select name="singleSelect" id="singleSelect" ng-model="searchFilter">
        <option value="Singapore">Singapore</option>
        <option value="Raffles Place, Cecil, Marina, People's Park">Raffles Place, Cecil, Marina, People's Park</option>
        <option value="Anson, Tanjong Pagar">Anson, Tanjong Pagar</option>
        <option value="Queenstown, Tiong Bahru">Queenstown, Tiong Bahru</option>
        <option value="Telok Blangah, Harbourfront">Telok Blangah, Harbourfront</option>
        <option value="Pasir Panjang, Hong Leong Garden, Clementi New Town">Pasir Panjang, Hong Leong Garden, Clementi New Town</option>
        <option value="High Street, Beach Road (part)">High Street, Beach Road (part)</option>
        <option value="Middle Road, Golden Mile">Middle Road, Golden Mile</option>
        <option value="Little India">Little India</option>
        <option value="Orchard, Cairnhill, River Valley">Orchard, Cairnhill, River Valley</option>
        <option value="Ardmore, Bukit Timah, Holland Road, Tanglin">Ardmore, Bukit Timah, Holland Road, Tanglin</option>
        <option value="Watten Estate, Novena, Thomson">Watten Estate, Novena, Thomson</option>
        <option value="Balestier, Toa Payoh, Serangoon">Balestier, Toa Payoh, Serangoon</option>
        <option value="Macpherson, Braddell">Macpherson, Braddell</option>
        <option value="Geylang, Eunos">Geylang, Eunos</option>
        <option value="Katong, Joo Chiat, Amber Road">Katong, Joo Chiat, Amber Road</option>
        <option value="Bedok, Upper East Coast, Eastwood, Kew Drive">Bedok, Upper East Coast, Eastwood, Kew Drive</option>
        <option value="Loyang, Changi">Loyang, Changi</option>
        <option value="Tampines, Pasir Ris">Tampines, Pasir Ris</option>
        <option value="Serangoon Garden, Hougang, Ponggol">Serangoon Garden, Hougang, Ponggol</option>
        <option value="Bishan, Ang Mo Kio">Bishan, Ang Mo Kio</option>
        <option value="Upper Bukit Timah, Clementi Park, Ulu Pandan">Upper Bukit Timah, Clementi Park, Ulu Pandan</option>
        <option value="Jurong">Jurong</option>
        <option value="Hillview, Dairy Farm, Bukit Panjang, Choa Chu Kang">Hillview, Dairy Farm, Bukit Panjang, Choa Chu Kang</option>
        <option value="Lim Chu Kang, Tengah">Lim Chu Kang, Tengah</option>
        <option value="Kranji, Woodgrove">Kranji, Woodgrove</option>
        <option value="Upper Thomson, Springleaf">Upper Thomson, Springleaf</option>
        <option value="Yishun, Sembawang">Yishun, Sembawang</option>
        <option value="Seletar">Seletar</option>

      </select>
    </div>
</div>

<!-- Container (data Section) -->
<div id="data" class="bg-1">
  <div class="container">
    <h3 class="text-center">DATA</h3>
    <h4 class="text-center">Let's take a look at the numbers.
    </h4>

    <div class="row text-center">
      <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
        <div class="thumbnail">
          <h4>Totals</h4>
          <h5>How many?</h5>
          <br>
            <div class="">
                <p>Number of Listings: {{ countListings()  }}</p>
                <p>Number of Beds: {{ countBeds()  }}</p>
            </div>
        </div>
      </div>
      <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
        <div class="thumbnail">
          <h4>Prices</h4>
          <h5>How much?</h5>
          <br>
            <div class="">
              <p>Average Monthly Rental: {{ averagePrice() | currency  }}</p>
              <p>Average PSF: {{ averagePSF() | currency }}</p>
              <p>Highest Rental: {{ highestRental() | currency }}</p>
              <p>Lowest Rental: {{ lowestRental() | currency }}</p>
            </div>
          <br /><br />
        </div>
      </div>
      <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
        <div class="thumbnail">
          <h4>Size</h4>
          <h5>How big?</h5>
          <br>
            <div class="">
              <p>Average Size per Listing: {{ averageSize() | number:2 }}</p>
             <p>Average Number Bedrooms per Listing: {{ averageBeds() | number:2  }}</p>
            </div>
        </div>
      </div>
    </div>
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
          <table class="table table-striped">
            <tr>
              <th>Property Type</th>
              <th>Number of Listings</th>
              <th>Average Monthly Rental</th>
              <th>Average Size</th>
            </tr>
            <tr ng-repeat="ptype in propertyTypeData()">
                <td>{{ptype.name}}</td>
                <td>{{ptype.listings}}</td>
                <td>{{ptype.AvgRental | currency }}</td>
                <td>{{ptype.AvgSize | number:2}}</td>
            </tr>
          </table>
        </div>
    </div>



  </div>
</div>


<!-- Footer -->
<footer class="text-center">
  <a class="up-arrow" href="#myPage" data-toggle="tooltip" title="TO TOP">
    <span class="glyphicon glyphicon-chevron-up"></span>
  </a><br><br>
  <p>&copy; 2016 Just Mi. All rights reserved</p>
</footer>

  <script>
    var app = angular.module('Ploperty',[]);

     app.controller('PlopertyController', function($scope, $http, $rootScope){
         var Ploperty = this;
         Ploperty.pdata  = null;

         Ploperty.avg_price = 0;

         Ploperty.getData = function() {
             $http.get('https://raw.githubusercontent.com/winstonmi/ploperty/gh-pages/public/jus.geojson').success(function(data) {
                 //Ploperty.pdata = data
                 $scope.items =  data;
                 console.log('Get geojson data success')
                 //console.log(Ploperty.pdata.features[0].properties.price)
                 updateData();
             }) //close $http
        }()//close getData function and run it

        function avg(sum,count) {
          return sum/count;
        }
        //
        //updates various calculations in one place
        function updateData() {
          Ploperty.avg_price = avg(sum_price(),count_all());
        }

        function sum_price() {
          var result =0;
          for(var i=0; i<$scope.items.features.length; i++) {
            result += $scope.items.features[i].properties.price2;
          }
          return result;
        }

        function count_all(){
          return $scope.items.features.length;
        }

        $scope.countListings = function() {
          if($scope.items===undefined ||  $scope.items.features.length===0) return 0

          var count =0;
          var searchTerm;
          if($scope.searchFilter === undefined ) {
            searchTerm = ''
          } else {
            searchTerm=$scope.searchFilter.concat(' ')
          }

          //if (searchTerm == 'Singapore' ) searchTerm = ''
          // console.log(searchTerm)
          // console.log('Singapore')
          // console.log("test singapore: " + (searchTerm == 'Singapore '))
          // console.log("length: " + searchTerm.length + ' ' + 'Singapore '.length)
          for(var i=0; i<$scope.items.features.length; i++) {
            if(searchTerm === '' || searchTerm == 'Singapore ' || $scope.items.features[i].properties.district==searchTerm){
              count +=1
            }
          }
          return count;
        }

        $scope.countBeds = function() {
          if($scope.items===undefined ||  $scope.items.features.length===0) return 0

          var count =0;
          var searchTerm;
          if($scope.searchFilter === undefined ) {
            searchTerm = ''
          } else {
            searchTerm=$scope.searchFilter.concat(' ')
          }

          //if (searchTerm == 'Singapore' ) searchTerm = ''
          // console.log(searchTerm)
          // console.log('Singapore')
          // console.log("test singapore: " + (searchTerm == 'Singapore '))
          // console.log("length: " + searchTerm.length + ' ' + 'Singapore '.length)
          for(var i=0; i<$scope.items.features.length; i++) {
            if(searchTerm === '' || searchTerm == 'Singapore ' || $scope.items.features[i].properties.district==searchTerm){
              count += $scope.items.features[i].properties.bed_no;
            }
          }
          return count;
        }

        $scope.averagePrice = function() {
          if($scope.items===undefined ||  $scope.items.features.length===0) return 0

          var sum =0;
          var count =0;
          var searchTerm;
          if($scope.searchFilter === undefined ) {
            searchTerm = ''
          } else {
            searchTerm=$scope.searchFilter.concat(' ')
          }

          // console.log("searchFilter: " + searchTerm)
          // console.log('first district: '+  $scope.items.features[0].properties.district.length)
          // console.log($scope.items.features[0].properties.district == searchTerm)
          for(var i=0; i<$scope.items.features.length; i++) {
            if(searchTerm === '' || searchTerm == 'Singapore ' || $scope.items.features[i].properties.district==searchTerm){
              sum += $scope.items.features[i].properties.price2;
              count += 1
            }
          }
          return (sum / count);
        }

        $scope.averagePSF = function() {
          if($scope.items===undefined ||  $scope.items.features.length===0) return 0

          var sum =0;
          var count =0;
          var searchTerm;
          if($scope.searchFilter === undefined ) {
            searchTerm = ''
          } else {
            searchTerm=$scope.searchFilter.concat(' ')
          }

          for(var i=0; i<$scope.items.features.length; i++) {
            if(searchTerm === '' || searchTerm == 'Singapore ' || $scope.items.features[i].properties.district==searchTerm){
              sum += $scope.items.features[i].properties.psf2;
              count += 1
            }
          }
          return (sum / count);
        }

        $scope.averageSize = function() {
          if($scope.items===undefined ||  $scope.items.features.length===0) return 0

          var sum =0;
          var count =0
          var searchTerm;
          if($scope.searchFilter === undefined ) {
            searchTerm = ''
          } else {
            searchTerm=$scope.searchFilter.concat(' ')
          }

          for(var i=0; i<$scope.items.features.length; i++) {
            if(searchTerm === '' || searchTerm == 'Singapore ' || $scope.items.features[i].properties.district==searchTerm){
              sum += $scope.items.features[i].properties.size2;
              count +=1
            }
          }
          return sum/count;
        }


        $scope.averageBeds = function() {
          if($scope.items===undefined ||  $scope.items.features.length===0) return 0

          var sum =0;
          var count =0
          var searchTerm;
          if($scope.searchFilter === undefined ) {
            searchTerm = ''
          } else {
            searchTerm=$scope.searchFilter.concat(' ')
          }

          for(var i=0; i<$scope.items.features.length; i++) {
            if(searchTerm === '' || searchTerm == 'Singapore ' || $scope.items.features[i].properties.district==searchTerm){
              sum += $scope.items.features[i].properties.bed_no;
              count +=1
            }
          }
          return sum/count;
        }

        $scope.highestRental = function() {
          if($scope.items===undefined ||  $scope.items.features.length===0) return 0

          var maxpx =0;
          var searchTerm;
          if($scope.searchFilter === undefined ) {
            searchTerm = ''
          } else {
            searchTerm=$scope.searchFilter.concat(' ')
          }

          for(var i=0; i<$scope.items.features.length; i++) {
            if(searchTerm === '' || searchTerm == 'Singapore ' || $scope.items.features[i].properties.district==searchTerm){
                if($scope.items.features[i].properties.price2 > maxpx)
                  maxpx = $scope.items.features[i].properties.price2
            }
          }
          return maxpx;
        }
        $scope.lowestRental = function() {
          if($scope.items===undefined ||  $scope.items.features.length===0) return 0

          var minpx = $scope.highestRental();
          var searchTerm;
          if($scope.searchFilter === undefined ) {
            searchTerm = ''
          } else {
            searchTerm=$scope.searchFilter.concat(' ')
          }

          for(var i=0; i<$scope.items.features.length; i++) {
            if(searchTerm === '' || searchTerm == 'Singapore ' || $scope.items.features[i].properties.district==searchTerm){
                if($scope.items.features[i].properties.price2 < minpx)
                  minpx = $scope.items.features[i].properties.price2
            }
          }
          return minpx;
        }

        $scope.propertyTypeData = function() {
          if($scope.items===undefined ||  $scope.items.features.length===0) return 0
          var condo = { "name": "Condo", "listings": 0, "sumRental": 0, "AvgRental": 0, "sumSize": 0, "AvgSize": 0}
          var hdb = {"name": "HDB", "listings": 0, "sumRental": 0, "AvgRental": 0, "sumSize": 0, "AvgSize": 0}
          var landed = {"name": "Landed", "listings": 0,"sumRental": 0, "AvgRental": 0, "sumSize": 0, "AvgSize": 0}
          var searchTerm;
          if($scope.searchFilter === undefined ) {
            searchTerm = ''
          } else {
            searchTerm=$scope.searchFilter.concat(' ')
          }

          for(var i=0; i<$scope.items.features.length; i++) {
            if(searchTerm === '' || searchTerm == 'Singapore ' || $scope.items.features[i].properties.district==searchTerm){
                 var ptype= $scope.items.features[i].properties.property_type
                if(ptype == 'Apartment' || ptype == 'Condominium' || ptype == 'Walk-up') {
                  condo.listings +=1
                  condo.sumRental += $scope.items.features[i].properties.price2
                  condo.sumSize += $scope.items.features[i].properties.size2
                } else if  ( ptype == 'HDB Apartment' || ptype == 'Executive Condominium') {
                  hdb.listings +=1
                  hdb.sumRental += $scope.items.features[i].properties.price2
                  hdb.sumSize += $scope.items.features[i].properties.size2
                } else {
                  landed.listings +=1
                  landed.sumRental += $scope.items.features[i].properties.price2
                  landed.sumSize += $scope.items.features[i].properties.size2
                }
            }
          }
          if(condo.listings === 0 ) {
            condo.AvgRental = 0
          } else {
          condo.AvgRental = condo.sumRental/condo.listings;
          condo.AvgSize = condo.sumSize/condo.listings;
          }

          if(hdb.listings === 0 ) {
            hdb.AvgRental = 0
          } else {
          hdb.AvgRental = hdb.sumRental/hdb.listings;
          hdb.AvgSize = hdb.sumSize/hdb.listings;
          }

          if(landed.listings === 0 ) {
            landed.AvgRental = 0
          } else {
          landed.AvgRental = landed.sumRental/landed.listings;
          landed.AvgSize = landed.sumSize/landed.listings;
          }

          return [hdb, condo, landed];
        }

     })//close angular controller



  </script>

  <!-- Mapbox.js -->
  <script>
  $(function() {
    //console.log("hi")
    L.mapbox.accessToken = 'pk.eyJ1Ijoid2luc3Rvbm1pIiwiYSI6ImNpcmx2NTJ5MjAwNWJmYW02bGZiMmN6ZmMifQ.DfLwDrBNUttzcAazjo6pqw';

      //SG data
      var mapCluster = L.mapbox.map('map-cluster')
        .setView([1.3521,103.8198], 12)
        .addLayer(L.mapbox.tileLayer('mapbox.streets'));
      L.mapbox.featureLayer()
        .loadURL('https://raw.githubusercontent.com/winstonmi/ploperty/gh-pages/public/jus.geojson')
        .on('ready', function(e) {
          var clusterGroup = new L.MarkerClusterGroup({
            iconCreateFunction: function(cluster) {
              // var markers = cluster.getAllChildMarkers();
              // var n = 0;
              // for (var i = 0; i < markers.length; i++) {
              //   n += markers[i].number;
              // }
              // var small = n < 5;
              // var className = small ? 'mycluster1' : 'mycluster2';
              // var size = small ? 10 : 20;
              // return L.divIcon({ html: n, className: className, iconSize: L.point(size, size) });

              return L.mapbox.marker.icon({
                // show the number of markers in the cluster on the icon.
                'marker-symbol': cluster.getChildCount(),
                'marker-color': '#78c942'
              });
            }
          });
          e.target.eachLayer(function(layer) {
              clusterGroup.addLayer(layer);
        });
        mapCluster.addLayer(clusterGroup);
      });
      mapCluster.scrollWheelZoom.disable();

  })
  </script>



</body>
</html>
